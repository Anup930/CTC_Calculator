<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CTC Calculator — Hosted on GitHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">Employee CTC Calculator</h1>
      <div id="statusIndicator" class="text-sm text-amber-600">Checking connection...</div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section class="col-span-1 bg-white p-5 rounded-2xl shadow">
        <h2 class="font-medium mb-3">Add Employee</h2>
        <form id="empForm" class="space-y-4">
          <div class="p-3 bg-slate-100 rounded-lg">
            <label class="block text-sm font-medium mb-2">Calculation Mode</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2"><input type="radio" name="calcMode" value="monthly" checked> <span>Monthly Gross</span></label>
              <label class="flex items-center gap-2"><input type="radio" name="calcMode" value="yearly"> <span>Yearly CTC</span></label>
            </div>
          </div>

          <div>
            <label class="block text-sm">Employee ID</label>
            <input id="empId" required class="w-full p-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm">Name</label>
            <input id="name" required class="w-full p-2 border rounded" />
          </div>

          <div id="monthlyInputWrap">
            <label class="block text-sm">Gross Monthly (₹)</label>
            <input id="grossMonthly" type="number" class="w-full p-2 border rounded" />
          </div>
          <div id="yearlyInputWrap" style="display:none;">
            <label class="block text-sm">Net CTC Yearly (₹)</label>
            <input id="yearlyCtc" type="number" class="w-full p-2 border rounded" />
          </div>
          
          <div class="flex items-center gap-4 flex-wrap pt-2">
            <label class="flex items-center gap-2"><input id="epf" type="checkbox" checked> <span>EPF</span></label>
            <label class="flex items-center gap-2"><input id="bonusCheck" type="checkbox"> <span>Bonus</span></label>
            <label class="flex items-center gap-2"><input id="fuelCheck" type="checkbox"> <span>Fuel</span></label>
            <label class="flex items-center gap-2"><input id="ptCheck" type="checkbox" checked> <span>PT</span></label>
          </div>

          <div id="ptAmountWrap" class="pl-4 border-l-2">
            <label class="block text-xs font-medium">Monthly PT Amount (₹)</label>
            <input id="ptMonthlyAmount" type="number" value="200" class="w-full p-1 border rounded text-sm" />
          </div>

          <div class="flex gap-2 pt-4">
            <button type="submit" id="addBtn" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed">Add to Sheet</button>
            <button type="button" id="calcPreview" class="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300">Preview</button>
          </div>
        </form>
      </section>

      <section class="col-span-1 md:col-span-2 bg-white p-5 rounded-2xl shadow">
        <h2 class="font-medium mb-3">Breakdown Preview</h2>
        <div id="previewCard" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="text-slate-400 italic">Enter details and click "Preview" to enable adding...</div>
        </div>
      </section>
    </main>

    <section class="mt-6 bg-white p-5 rounded-2xl shadow">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-medium">Database (Google Sheets)</h3>
        <button id="refresh" class="text-sm text-indigo-600 font-medium hover:underline">Refresh List</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-600"><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
// --- CONFIGURATION ---
// Replace this with your Google Apps Script Web App URL
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpVyeLn1lfgqTlGslX_UFANzjVwuxfzcsA_1R5haR0CsyVShZJRiXoDyCsLsTpcwyg/exec';

const qs = sel => document.querySelector(sel);
const currency = x => (x === '-' || isNaN(x)) ? '-' : '₹' + Number(x).toLocaleString('en-IN');

let isCalculated = false;

// --- CORE CALCULATION LOGIC ---
function calculateAllFields(inputs) {
    let { grossMonthly, epf, bonusChecked, fuelChecked, ptChecked, ptMonthlyAmount } = inputs;
    grossMonthly = Number(grossMonthly) || 0;
    
    // 1. Basic/HRA/TA split
    let basic = Math.round(grossMonthly * 0.5);
    let hra = Math.round(grossMonthly * 0.35);
    let ta = Math.round(grossMonthly * 0.15);
    
    // 2. Allowances & Bonus
    let fuel = fuelChecked ? (grossMonthly >= 50000 ? 7500 : Math.round(grossMonthly * 0.15)) : 0;
    let bonus = bonusChecked ? grossMonthly : 0;
    
    // 3. EPF (Restricted logic: max ₹1800)
    let epfEmp = epf ? Math.min(Math.round(basic * 0.12), 1800) : 0;
    let epfEmployer = epf ? Math.min(Math.round(basic * 0.12), 1800) : 0;
    
    // 4. ESI (Mandatory if Gross <= ₹21,000)
    let isEsi = grossMonthly <= 21000;
    let esiEmployee = isEsi ? Math.round(grossMonthly * 0.0075) : 0; // 0.75% deduction
    let esiEmployer = isEsi ? Math.round(grossMonthly * 0.0325) : 0; // 3.25% cost to company
    
    // 5. Professional Tax (PT)
    let pt = ptChecked ? (Number(ptMonthlyAmount) || 0) : 0;

    // --- TOTALS ---
    let monthlyEmployerContributions = epfEmployer + esiEmployer; 
    let monthlyCTC = grossMonthly + fuel + monthlyEmployerContributions;
    let netYearlyCTC = (monthlyCTC * 12) + bonus;
    
    let grossSalaryPayable = basic + hra + ta + fuel;
    let totalDeductions = epfEmp + esiEmployee + pt;
    let netTakeHome = grossSalaryPayable - totalDeductions;

    return {
        'Gross Monthly': grossMonthly,
        'Net CTC Yearly': netYearlyCTC,
        'Monthly CTC': monthlyCTC,
        'Net Take-Home (Monthly)': netTakeHome,
        'Basic': basic, 'HRA': hra, 'TA': ta, 'Fuel': fuel,
        'Bonus Amount': bonus, 
        'EPF Employee': epfEmp, 'EPF Employer': epfEmployer,
        'ESI Employee': esiEmployee, 'ESI Employer': esiEmployer,
        'PT Amount': pt, 'Gross Salary Payable': grossSalaryPayable
    };
}

// Binary Search for exact Yearly CTC reverse calculation
function findGrossFromTarget(targetCTC, options) {
    let low = 0, high = targetCTC, bestGuess = 0;
    for (let i = 0; i < 40; i++) {
        let guess = (low + high) / 2;
        let result = calculateAllFields({ grossMonthly: guess, ...options });
        if (result['Net CTC Yearly'] < targetCTC) { low = guess; } 
        else { high = guess; }
        bestGuess = guess;
    }
    return bestGuess;
}

// --- UI INTERACTIONS ---
function updateButtonState() {
    qs('#addBtn').disabled = !isCalculated;
}

function showPreview() {
    const mode = qs('input[name="calcMode"]:checked').value;
    const commonInputs = {
        epf: qs('#epf').checked,
        bonusChecked: qs('#bonusCheck').checked,
        fuelChecked: qs('#fuelCheck').checked,
        ptChecked: qs('#ptCheck').checked,
        ptMonthlyAmount: qs('#ptMonthlyAmount').value
    };

    let inputs = { ...commonInputs };
    if (mode === 'yearly') {
        const target = Number(qs('#yearlyCtc').value) || 0;
        inputs.grossMonthly = findGrossFromTarget(target, commonInputs);
    } else {
        inputs.grossMonthly = qs('#grossMonthly').value;
    }

    const data = calculateAllFields(inputs);
    const card = qs('#previewCard');
    
    // Define display order
    const order = [
        'Net CTC Yearly', 'Monthly CTC', 'Gross Monthly', 'Net Take-Home (Monthly)',
        'Basic', 'HRA', 'TA', 'Fuel', 'Bonus Amount', 
        'EPF Employee', 'ESI Employee', 'PT Amount', 'EPF Employer', 'ESI Employer'
    ];

    card.innerHTML = order.map(key => `
        <div class="p-3 bg-slate-50 rounded border ${key.includes('Net CTC') ? 'bg-indigo-50 border-indigo-200' : 'border-transparent'}">
            <div class="text-xs text-slate-500">${key}</div>
            <div class="font-medium ${key.includes('Net CTC') ? 'text-indigo-700 font-bold' : ''}">${currency(data[key])}</div>
        </div>
    `).join('');

    isCalculated = true;
    updateButtonState();
    return data;
}

// PT Toggle
qs('#ptCheck').addEventListener('change', e => {
    qs('#ptAmountWrap').style.display = e.target.checked ? 'block' : 'none';
    isCalculated = false;
    updateButtonState();
});

// Reset preview on input change
qs('#empForm').addEventListener('input', (e) => {
    if(e.target.id !== 'calcPreview') {
        isCalculated = false;
        updateButtonState();
    }
});

qs('input[name="calcMode"]').parentElement.parentElement.addEventListener('change', (e) => {
    qs('#monthlyInputWrap').style.display = qs('input[name="calcMode"]:checked').value === 'monthly' ? 'block' : 'none';
    qs('#yearlyInputWrap').style.display = qs('input[name="calcMode"]:checked').value === 'yearly' ? 'block' : 'none';
});

qs('#calcPreview').addEventListener('click', showPreview);

// --- SUBMISSION ---
qs('#empForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!isCalculated) return;

    const btn = qs('#addBtn');
    btn.textContent = 'Sending...';
    btn.disabled = true;

    const data = showPreview(); // Re-run to get latest data
    const payload = {
        'Emp ID': qs('#empId').value,
        'Name': qs('#name').value,
        ...data
    };

    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Crucial for Google Apps Script redirects
            body: JSON.stringify(payload)
        });
        alert('Employee data saved to Google Sheet!');
        e.target.reset();
        isCalculated = false;
        updateButtonState();
        qs('#previewCard').innerHTML = '<div class="text-slate-400 italic">Enter details and click "Preview" to enable adding...</div>';
        fetchList();
    } catch (err) {
        alert('Failed to save data: ' + err.message);
    } finally {
        btn.textContent = 'Add to Sheet';
    }
});

// --- GOOGLE SHEETS LIST ---
async function fetchList() {
    try {
        const res = await fetch(`${APPS_SCRIPT_URL}?action=get`);
        const j = await res.json();
        if (j.status === 'ok') renderTable(j.rows);
    } catch (e) {
        console.error("List fetch error:", e);
    }
}

function renderTable(rows) {
    if (!rows || rows.length === 0) return;
    const headers = Object.keys(rows[0]);
    qs('#tableHead').innerHTML = headers.map(h => `<th class="px-3 py-2 text-left text-xs font-bold uppercase tracking-wider">${h}</th>`).join('');
    qs('#tableBody').innerHTML = rows.map(r => `
        <tr class="border-t hover:bg-slate-50 transition-colors">
            ${headers.map(h => `<td class="px-3 py-2 whitespace-nowrap">${typeof r[h] === 'number' ? currency(r[h]) : r[h]}</td>`).join('')}
        </tr>
    `).join('');
}

qs('#refresh').addEventListener('click', fetchList);
window.onload = () => {
    updateButtonState();
    fetchList();
};
</script>
</body>
</html>
